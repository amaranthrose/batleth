defmodule Clock do
    

    @doc """
        Starts a new thread to count time for adding records. Takes one parameter - pid of the writer.
        If succeed, returns a tuple {:ok, pid}
        """
	def start(pid, pid_r) do
        	Task.start_link(fn() -> loop(pid, pid_r) end)
	end




    	defp loop(pid, pid_r) do
        	send pid, {self()}
		send pid, {:get, :last_timestamp, self()}

		receive do
			{:ok, last_timestamp, self()} -> 
				{ms, s, _} = :os.timestamp
				time_dif = ms * 1_000_000 + s - last_timestamp

				if time_dif >= 60 do
					send pid_r, {:read, self()}
					receive do
						{:ok, percentage, status, caller} ->
							send pid, {:add, {:status, :pr}, self()}
							receive do
								{:ok} -> :timer.sleep(60000)
								{:error, :db} -> :not_implemented
							end

							
						_ -> :not_implemented
					end

				else
					:timer.sleep(60000 - time_dif*1000)
					loop(pid, pid_r)
				end

			{:error, :not_present} -> :not_implemented
			{:error, :db} -> :not_implemented
		end

        	receive do
			
			{:error, problem} -> :not_implemented
			_ -> :timer.sleep(60000)
			loop(pid, pid_r)
		end
    	end
    
end

